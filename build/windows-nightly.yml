# Nightly build for Windows. Produces NuGet packages
name: 0.3.$(Date:yyMM).$(Date:dd)$(Rev:rr)

resources:
- repo: self
  clean: true
  
trigger: none # disable CI build
  
steps:
- script: echo $(Build.BuildNumber)

- task: Bash@3
  inputs:
    filePath: build/updateversion.sh
    workingDirectory: build
    arguments: $(Build.BuildNumber)

- template: windows.yml
  parameters:
    buildConfiguration: 'Release'
    testSuite: 'nightly'
    testPlatform: 'all'
    testRunner: 'vstest'

- task: Bash@3
  inputs:
    filePath: build/copyassemblies.sh
    arguments: ../bin Release
    workingDirectory: build

- task: NuGetCommand@2
  inputs:
    command: pack
    packagesToPack: build/*.nuspec
    includeSymbols: true
    buildProperties: version=$(Build.BuildNumber);bin=../bin

- task: CopyFiles@2
  inputs:
    sourceFolder: bin
    targetFolder: $(Build.ArtifactStagingDirectory)

- task: PublishBuildArtifacts@1
  inputs:
    artifactName: 'Everything'